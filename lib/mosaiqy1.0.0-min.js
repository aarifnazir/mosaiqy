(function(d){var a=(function(h,l){var k=document.createElement("div"),i=function(m){return m.replace(/([A-Z])/g,function(n,o){return"-"+o.toLowerCase()})},g,j={msie:"MsTransition",opera:"OTransition",mozilla:"MozTransition",webkit:"WebkitTransition"};for(var f in j){if(j.hasOwnProperty(f)){if(h[f]){g=j[f]}}}return{isEnabled:(function(m){return !!(m[l]||g in m||(h.opera&&parseFloat(h.version)>10.49))}(k.style)),transitionEnd:(function(){return(h.opera)?"oTransitionEnd":(h.webkit)?"webkitTransitionEnd":"transitionend"}()),duration:i(g)+"-duration"}}(d.browser,"transition")),b=function(g){var l,h,m,k,f=[];l=g;for(h=0;h<l;h++){f[h]=h}while(--l){var h=~~(Math.random()*(l+1));var m=f[l];var k=f[h];f[l]=k;f[h]=m}return f},c=function(n){var A={animationDelay:3000,animationSpeed:800,avoidDuplicates:false,cols:4,fadeSpeed:750,indexData:0,loop:true,rows:3,template:null},B,h,g,j,k=[],q=[],C={},s=false,r=false,u={},y=(n.browser.opera)?n("html"):n("html,body"),i,p=function(E){var D="";if(typeof C[E]==="undefined"){C[E]=A.template.replace(/\$\{([^\}]+)\}/gm,function(G,F){if(typeof A.data[E][F]==="undefined"){return F}return A.data[E][F]})}D=C[E];if(typeof window.innerShiv==="function"){D=window.innerShiv(D)}return n(D)},x=function(){var D=g.eq(0);u={w:D.outerWidth(true),h:D.outerHeight(true)};g.each(function(E,F){n(F).css({top:u.h*(~~(E/A.cols)),left:u.w*(E%A.cols)})});h.css({minHeight:u.h*A.rows,width:u.w*A.cols});B.css({minHeight:u.h*A.rows,width:u.w*A.cols})},f=function(){var G,F,E,D={col:"li:nth-child($0n+$1)",row:"li:nth-child(n+$0):nth-child(-n+$1)"};for(F=0;F<A.cols;F=F+1){E=D.col.replace(/\$(\d)/g,function(H,I){return[A.cols,F+1][I]});k.push({prop:"top",selector:E,node:F,position:{top:-(u.h),left:u.w*F}});k.push({prop:"top",selector:E,node:A.cols*(A.rows-1)+F,position:{top:u.h*A.rows,left:u.w*F}})}for(G=0,F=0;F<A.rows;F=F+1){E=D.row.replace(/\$(\d)/g,function(H,I){return[G+1,G+A.cols][I]});k.push({prop:"left",selector:E,node:G,position:{top:u.h*F,left:-(u.w)}});k.push({prop:"left",selector:E,node:G+=A.cols,position:{top:u.h*F,left:u.w*A.cols}})}k[k.length-1].node-=1},z=function(){var H,G,F,I,E,J,D=n.Deferred();H=q.pop();J=((H&1)===0);E=B.find(k[H].selector);F=g.eq(k[H].node);I=(H<k.length-1)?n("<li />").insertBefore(F):n("<li />").insertAfter(F);I.data("mosaiqy-index",A.indexData);G=p(A.indexData);G.appendTo(I.css(k[H].position));n.when(I.find("img").mosaiqyImagesLoad()).fail(function(){I.remove();D.reject()}).done(function(){var O=k[H].prop,N=(O==="left")?u.w:u.h,M=E.add(I),K=M.length,L={};L[O]="+="+(J?N:-N)+"px";M.animate(L,A.animationSpeed,function(){var P;if(--K){return}if(J){E.last().remove()}else{E.first().remove()}E=(J)?E.slice(0,E.length-1):E.slice(1,E.length);if(O==="top"){P=E.length;E.each(function(Q){var R,U,T,S;g=B.find("li:not(.mosaiqy-zoom)");R=n(this);U=g.index(R);T=(J)?A.cols:-(A.cols-((1===P-Q)?0:1));if(!!T){S=U+T;if(S<g.length){R.insertBefore(g.eq(S))}else{R.appendTo(h)}}})}D.resolve()})});return D.promise()},w=function(){var E=A.data.length,D=[];if(A.indexData===A.data.length){if(!A.loop){return o()}else{A.indexData=0}}if(A.avoidDuplicates){g.each(function(){var F=n(this).data("mosaiqy-index");D[F]=F});while(E--){if(typeof D[A.indexData]!=="undefined"){A.indexData=A.indexData+1;if(A.indexData===A.data.length){if(!A.loop){return o()}else{A.indexData=0}}continue}break}}},l=function(){if(!s&&!r){r=true;if(q.length===0){q=b(k.length)}w();n.when(z()).done(function(){g=h.find("li:not(.mosaiqy-zoom)");A.indexData=A.indexData+1;r=false}).always(function(){i=setTimeout(function(){l()},A.animationDelay)})}else{i=setTimeout(function(){l()},A.animationDelay)}},o=function(){s=true},v=function(){s=false},t=function(G){var H,P,K,J,F,M,D,Q,E,O;function I(){var R=n.Deferred();if((H||{}).length){M.stop(true)._animate({opacity:"0"},A.fadeSpeed/4);D.stop(true)._animate({opacity:"0"},A.fadeSpeed/2);g.removeClass("zoom");n.when(H.stop(true)._animate({height:"0"},A.fadeSpeed)).then(function(){H.remove();H=null;R.resolve()})}else{R.resolve()}return R.promise()}function N(){var S,T,R;F=H.find("figure");M=H.find("figcaption");S=n('<img class="mosaiqy-zoom-image" />').attr({src:P.find("a").attr("href")});S.appendTo(F);if(S.get(0).height===0){S.hide()}R=(!!S.get(0).complete)?S.height():200;H._animate({height:R+"px"},A.fadeSpeed);T=P.find("img").prop("longDesc");if(!!T){S.wrap(n("<a />").attr({href:T}))}n.when(S.mosaiqyImagesLoad(function(U){setTimeout(function(){var V=(!!S.get(0).height)?A.fadeSpeed:0;U.fadeIn(V,function(){D=n('<a class="mosaiqy-zoom-close">Close</a>').attr({href:"#"}).bind("click.mosaiqy",function(W){n.when(I()).then(function(){B.removeClass("zoom");J=false;v()});W.preventDefault()}).appendTo(F)._animate({opacity:"1"},A.fadeSpeed/2);M.html(P.find("figcaption").html())._animate({opacity:"1"},A.fadeSpeed)})},A.fadeSpeed/1.2)})).done(function(){if(R<S.height()){H._animate({height:S.height()+"px"},A.fadeSpeed)}}).fail(function(){D.trigger("click.mosaiqy")})}function L(R){J=true;n.when(R()).done(function(){var S;B.addClass("zoom");P.addClass("zoom");g=B.find("li:not(.mosaiqy-zoom)");E=P.offset().top;Q=(document.body.scrollTop!==0)?document.body.scrollTop:document.documentElement.scrollTop;O=Math.abs(Q-E);S=(O>0)?((O*1.5)+400):0;H='<li class="mosaiqy-zoom"><figure><figcaption></figcaption></figure></li>';H=(typeof window.innerShiv==="function")?n(window.innerShiv(H)):n(H);if(K<g.length){H.insertBefore(g.eq(K))}else{H.appendTo(h)}if(typeof window.innerShiv==="function"){H=B.find(".mosaiqy-zoom")}n.when(y.stop()._animate({scrollTop:E},S)).done(function(){J=false;N()})})}G.live("click.mosaiqy",function(R){if(!r&&!J){o();P=n(this);K=A.cols*(Math.ceil((g.index(P)+1)/A.cols));if(!P.hasClass("zoom")){L(I)}}R.preventDefault()})},m=function(E){var F,D;while(E--){F=n("<li />").appendTo(h);F.data("mosaiqy-index",A.indexData);D=p(A.indexData);D.appendTo(F);A.indexData=A.indexData+1}};return{init:function(E,D){var F=0;A=n.extend(A,D);if(!((A.data||[]).length)){throw Error("Data object is empty");return false}if(!!A.template&&n(A.template).is("script")){A.template=n(A.template).text()||n(A.template).html()}else{throw Error("User template is not defined");return false}B=E;h=E.find("ul");g=E.find("li:not(.mosaiqy-zoom)");F=(A.cols*A.rows)-g.length;if(F){if(A.data.length>=F){A.indexData=g.length;m(F);g=E.find("li:not(.mosaiqy-zoom)")}else{throw Error("JSON data can't provide missing images on the HTML document.")}}j=E.find("img");x();f();B.delegate("ul","mouseenter.mosaiqy",function(){o()}).delegate("ul","mouseleave.mosaiqy",function(){if(!B.hasClass("zoom")){v()}});n.when(j.mosaiqyImagesLoad(function(G){G.animate({opacity:"1"},A.fadeSpeed)})).done(function(){B.removeClass("loading");t(g);i=setTimeout(function(){l()},A.animationDelay+2000)}).fail(function(){return false});return this}}},e=d.sub();e.fn.mosaiqyImagesLoad=function(j){var f=d.Deferred(),i=this.length,h=[],g=[],k=8419.78;if(i){this.each(function(){var l=this;d.when((function m(){var n=d.Deferred(),o=setTimeout(function(){d(l).trigger("error.mosaiqy")},k);d(l).one("load.mosaiqy",function(){clearInterval(o);n.resolve()}).bind("error.mosaiqy",function(){clearInterval(o);n.reject()}).attr("src",l.src);if(l.complete){d(l).trigger("load.mosaiqy")}return n.promise()}())).done(function(){h.push(l.src);if(j){j(d(l))}}).fail(function(){g.push(l.src)}).always(function(){i=i-1;if(i===0){if(g.length){f.reject()}else{f.resolve()}}})})}return f.promise()};e.fn.extend({_animate:d.fn.animate,animate:function(g,h,j,i){var f=(h&&typeof h==="object")?d.extend({},h):{duration:h,complete:i||!i&&j||d.isFunction(h)&&h,easing:i&&j||j&&!d.isFunction(j)&&j};return d(this).each(function(){var n=e(this),o=n.position(),l={},k;if(a.isEnabled){if(typeof g==="object"){for(var m in g){if(m==="left"||m==="top"){k=g[m].match(/^(?:\+|\-)=(\-?\d+)/);if(k&&k.length){l[m]=o[m]+parseInt(k[1],10)}}}}n.bind(a.transitionEnd,function(){if(d.isFunction(f.complete)){f.complete()}}).css(l).css(a.duration,(h/1000)+"s")}else{n._animate(g,f)}})}});d.fn.mosaiqy=function(f){if(this.length){return this.each(function(){var g=new c(e);g.init(e(this),f);d.data(this,"mosaiqy",g)})}}}(jQuery));